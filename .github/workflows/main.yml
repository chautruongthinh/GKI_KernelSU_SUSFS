name: Build Kernels

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Choose Release Type"
        required: true
        type: choice
        options:
          - Actions
          - Pre-Release
          - Release
        default: Actions
      build_selection:
        description: "Choose which kernels to build"
        required: true
        type: string
        default: Android13-5.15
      ksu_variant:
        description: "Choose KernelSU variant"
        required: true
        type: choice
        options:
          - KSU
          - WKSU
          - SukiSU
        default: KSU
      ksu_commit:
        description: "Optional KernelSU commit SHA"
        required: false
        type: string

jobs:
  build-android13-5-15:
    if: ( inputs.build_selection == 'Android13-5.15')
    uses: ./.github/workflows/kernel-a13-5-15.yml
    secrets: inherit
    with:
      ksu_variant: ${{ inputs.ksu_variant }}
      ksu_commit: ${{ inputs.ksu_commit }}

  release:
    runs-on: ubuntu-latest
    if: inputs.release_type != 'Actions'
    needs:
      - build-android13-5-15
    env:
      GH_TOKEN: ${{ github.token }}
      RELEASE_NAME: ${{ inputs.ksu_variant == 'SukiSU' && 'GKI Kernels With SukiSU & SUSFS v2.0.0' || 'GKI Kernels With WKSU & SUSFS v2.0.0' }}
      RELEASE_BODY: ""
    steps:      
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate New Tag
        if: inputs.release_type != 'Actions'
        run: |
          BASE_VERSION="v2.0.0"
          LATEST_TAG=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name' 2>/dev/null || echo "")
          if [[ $LATEST_TAG =~ ${BASE_VERSION}-R([0-9]+) ]]; then
              REVISION=${BASH_REMATCH[1]}
              NEW_REVISION=$((REVISION + 1))
          else
              NEW_REVISION=1
          fi
          
          NEW_TAG="${BASE_VERSION}-R${NEW_REVISION}"
          echo "New tag: $NEW_TAG"
          echo "NEW_TAG=${NEW_TAG}" >> $GITHUB_ENV

      - name: Set release body KSU
        if: inputs.ksu_variant != 'SukiSU'
        run: |
          cat << 'EOF' > release_body.md
      
          **IMPORTANT DISCLAIMER**
          This software is provided for testing and educational purposes only. Use at your own risk.
          The developers are not responsible for any damage, data loss, or issues that may occur.
          Please ensure you have proper backups before installation.

          ðŸ”¹ Normal 
          - Default kernel configuration 
          - Standard kernel module loading behavior 
          - Recommended for most users 

          Features:
          -> Wild KSU
          -> Multi Manager Support for WKSU, KernelSU-Next! Needs Testing: KSU, MKSU RKSU, xxKSU, KowSU and SukiSU (Best compatibility with WKSU, no support will be provided for other managers)
          -> SUSFS à¶ž v2.0.0
          -> Scope-Minimized Manual hooks v1.4
          -> Ptrace Patch Support for Older Kernels (<5.16)
          -> IPSet Support for Advanced Network Filtering
          -> Wireguard Support

          ðŸ”¹ BBG (Baseband-guard)
          - A lightweight LSM (Linux Security Module) for Android kernel
          - Blocks unauthorized writes to critical partitions/device nodes
          - Prevents malicious tampering with baseband and boot chain
          - Kernel-level protection via LSM hooks
          - Reduces risk of soft-brick/hard-brick issues          

          Notes:
          -> SUS SU Mode 2 will show as disabled or not compatible due to non-kprobe hooks and is not needed anymore!
          -> Official Kernel Flasher is broken with latest susfs, try https://github.com/fatalcoder524/KernelFlasher/
          -> **boot.img files**: Available as CI artifacts only - download from the Actions tab in the "Misc" Artifact
          -> **Warning**: boot.img files may not boot on some devices
          -> **Note:** For detailed commit information and component versions, please check the build summary in the "Misc" Artifact

          Module: 
          -> https://github.com/sidex15/ksu_module_susfs
      
          Managers:
          -> WKSU: https://github.com/WildKernels/Wild_KSU
          -> Next: https://github.com/KernelSU-Next/KernelSU-Next
          EOF

      - name: Set release body SukiSU
        if: inputs.ksu_variant == 'SukiSU'
        run: |
          cat << 'EOF' > release_body.md      
          This release includes SukiSU
        
          Features:
          -> SukiSU-Stable
          -> SUSFS à¶ž v2.0.0
          -> Manual Syscall Hooks for better hiding
          -> Magic Mount Support
          -> Simple hiding for LineageOS detection
          -> Futile hiding for jit-zygote-cache detection
          -> Wireguard Support
          -> BBR Supported
      
          <details>
          <summary>Notes:</summary>
          - -> In SUS SU Mode 2, it will show as disabled or incompatible, the reason is that non-kprobe hooks were used (when compiling the kernel), and non-kprobe hooks are no longer needed!
          - -> In the latest version of susfs, flashing AK3 compressed package with Kernel Flasher will brick your device, try [Horizon Kernel Flasher]\(https://github.com/libxzr/HorizonKernelFlasher)!
          </details>
        
          Modules:
          -> https://github.com/sidex15/ksu_module_susfs
          SukiSU Manager:
          -> https://github.com/ShirkNeko/SukiSU-Ultra
          EOF
          
      - name: Download Artifacts
        uses: actions/download-artifact@v5
        with:
          path: ./downloaded-artifacts
          pattern: "*-${{ inputs.ksu_variant }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.NEW_TAG }}
          prerelease: ${{ inputs.release_type == 'Pre-Release' }}
          name: ${{ env.RELEASE_NAME }}
          body_path: release_body.md
          
      - name: Upload Release Assets
        run: |
          shopt -s globstar
          echo "Uploading release assets..."          
          for file in ./downloaded-artifacts/**/*.zip ./downloaded-artifacts/**/*.img ./downloaded-artifacts/**/*.gz; do
            [ -f "$file" ] || continue
            echo "Uploading $file"
            gh release upload "${{ env.NEW_TAG }}" "$file" || echo "Failed to upload $file"
          done          
          echo "Upload completed!"